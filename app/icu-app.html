<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout">
<script src="/socket.io/socket.io.js"></script>

<dom-module id="icu-app">
    <style>
        #remote {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            box-shadow: 0px 2px 5px #888888;
            transform: rotateY(180deg);
        }

        #local {
            position: fixed;
            bottom: 50px;
            right: 50px;
            width: 200px;
            box-shadow: 0px 2px 5px #888888;
            transform: rotateY(180deg);
        }

    </style>
    <template>
        <paper-drawer-panel>
            <paper-header-panel drawer>
                <paper-toolbar>
                    <div class="title">Contacts</div>
                </paper-toolbar>
                <paper-menu on-tap="call">
                    <template id="peerList" is="dom-repeat" items="{{peers}}">
                        <paper-item data-id="{{item.id}}"> {{item.name}}</paper-item>
                    </template>
                </paper-menu>
            </paper-header-panel>

            <paper-header-panel main>
                <video id="remote"></video>
                <paper-material class="local">
                    <video id="local" muted></video>
                </paper-material>
            </paper-header-panel>
        </paper-drawer-panel>

        <paper-dialog id="nick" modal noCancelOnEscKey>
            <div>
                <paper-input id="nickname" type="text"></paper-input>
            </div>
            <div class="buttons">
                <paper-icon-button dialog-confirm icon="chevron-right"></paper-icon-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

        Polymer({
            is: 'icu-app',
            listeners: {
                'nick.iron-overlay-closed': 'nick'
            },
            properties:{
                peers:{
                    type:Array,
                    notify:true
                }
            },
            ready: function () {
                if (!localStorage.getItem('name')) {
                    this.$.nick.open();
                }
                var socket = io.connect();
                var self = this;
                this.peers=[];

                socket.on('setup',function(port){
                    console.log(port);
                });
                self.peer = new Peer({host: '/',port: 80,path:'/peerjs'});
                this.peer.on('open', function(id) {
                    console.log(id,socket.id);
                    socket.emit('new',{name:localStorage.getItem('name'),id:id,sid:socket.id});
                });

                this.peer.on('call', function (call) {
                    navigator.getUserMedia({video: true, audio: true}, function (stream) {
                        call.answer(stream); // Answer the call with an A/V stream.
                        var lvideo = document.querySelector('#local');
                        lvideo.src = window.URL.createObjectURL(stream);
                        lvideo.onloadedmetadata = function (e) {
                            lvideo.play();
                        };
                        call.on('stream', function (remoteStream) {
                            var video = document.querySelector('#remote');
                            video.src = window.URL.createObjectURL(remoteStream);
                            video.onloadedmetadata = function (e) {
                                video.play();
                            };
                        });
                    }, function (err) {
                        console.log('Failed to get local stream', err);
                        alert(err);
                    });
                });

                socket.on('peers',function(peers){
                    self.peers=peers.filter(function(val){
                        if('sid' in val && val.sid.indexOf(socket.id)==-1)return true;
                        else return false;
                    });;
                    console.log(self.peers);
                });
            },
            nick: function () {
                var nick = this.$.nickname.value;
                if (nick)
                    localStorage.setItem('name', nick);
                else
                    this.$.nick.open();
            },
            call: function(e){
                console.log(e);
                var self=this;
                navigator.getUserMedia({video: true, audio: true}, function (stream) {
                    var call = self.peer.call(e.target.dataId, stream);
                    var lvideo = document.querySelector('#local');
                    lvideo.src = window.URL.createObjectURL(stream);
                    lvideo.onloadedmetadata = function (e) {
                        lvideo.play();
                    };
                    call.on('stream', function (remoteStream) {
                        var video = document.querySelector('#remote');
                        video.src = window.URL.createObjectURL(remoteStream);
                        video.onloadedmetadata = function (e) {
                            video.play();
                        };
                    });
                }, function (err) {
                    console.log('Failed to get local stream', err);
                    alert(err);
                });
            }
        });
    </script>
</dom-module>